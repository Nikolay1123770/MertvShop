<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEPTB SHOP</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f0f11;
            --card-bg: #1c1c1e;
            --text-color: #ffffff;
            --accent-color: #a980f5;
            --accent-gradient: linear-gradient(135deg, #a980f5 0%, #7b51d8 100%);
            --secondary-text: #8e8e93;
            --border-radius: 16px;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* –°–∏—Å—Ç–µ–º–∞ —ç–∫—Ä–∞–Ω–æ–≤ */
        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* –°—Ç–∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ */
        header { text-align: center; margin-bottom: 25px; margin-top: 10px; }
        h1 { margin: 0; font-size: 26px; font-weight: 800; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p.subtitle { margin-top: 5px; color: var(--secondary-text); font-size: 14px; }
        .section-title { font-size: 13px; font-weight: 700; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; margin-left: 5px; }

        .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); }
        
        .stars-input-wrapper { position: relative; margin-top: 15px; }
        .stars-input { width: 100%; background: #2c2c2e; border: 2px solid transparent; color: white; padding: 14px; padding-right: 40px; border-radius: 12px; font-size: 18px; font-weight: 600; box-sizing: border-box; outline: none; transition: 0.3s; }
        .stars-input:focus { border-color: var(--accent-color); background: #3a3a3c; }
        .star-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 18px; pointer-events: none; }
        .price-tag { display: flex; justify-content: space-between; margin-top: 10px; font-size: 13px; color: var(--secondary-text); }
        
        .product-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 16px; background: var(--card-bg); border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.05); }
        .product-info h3 { margin: 0; font-size: 15px; font-weight: 600; }
        .product-info p { margin: 4px 0 0; color: var(--accent-color); font-weight: 600; font-size: 14px; }

        .counter { display: flex; align-items: center; gap: 12px; background: #2c2c2e; padding: 4px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-circle { width: 32px; height: 32px; border-radius: 50%; border: none; background: transparent; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .count-val { font-weight: 700; min-width: 20px; text-align: center; font-size: 16px; }

        /* –≠–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã */
        .payment-info { text-align: center; padding: 20px; }
        .total-amount { font-size: 42px; font-weight: 800; color: white; margin: 20px 0; }
        .order-id { font-family: monospace; color: var(--secondary-text); background: #2c2c2e; padding: 5px 10px; border-radius: 8px; }
        
        .btn-main {
            width: 100%; padding: 16px; border-radius: 14px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 10px; text-align: center;
        }
        .btn-pay { background: var(--accent-gradient); color: white; box-shadow: 0 4px 15px rgba(169, 128, 245, 0.4); }
        .btn-check { background: #2c2c2e; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-back { background: transparent; color: var(--secondary-text); }

        /* –≠–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞ */
        .success-icon { font-size: 80px; margin-bottom: 20px; display: block; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 1: –ö–ê–¢–ê–õ–û–ì -->
    <div id="view-catalog" class="view active">
        <header>
            <h1>MEPTB STORE</h1>
            <p class="subtitle">Premium Digital Goods</p>
        </header>

        <div class="section-title">Telegram Stars ‚≠êÔ∏è</div>
        <div class="card">
            <label style="font-weight: 600; font-size: 15px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
            <div class="stars-input-wrapper">
                <input type="number" inputmode="numeric" id="starsAmount" class="stars-input" placeholder="0" oninput="updateUI()">
                <span class="star-icon">‚≠êÔ∏è</span>
            </div>
            <div class="price-tag">
                <span>–ö—É—Ä—Å: 1.6‚ÇΩ / —à—Ç.</span>
                <span id="starsTotal" style="color: var(--accent-color); font-weight: 700;">0‚ÇΩ</span>
            </div>
        </div>

        <div class="section-title">Telegram Premium ‚ö°Ô∏è</div>
        <div class="product-item">
            <div class="product-info"><h3>3 –ú–µ—Å—è—Ü–∞</h3><p>1,250‚ÇΩ</p></div>
            <div class="counter">
                <button class="btn-circle" onclick="changeCount('tg_premium_3', -1)">‚àí</button>
                <span id="count-tg_premium_3" class="count-val">0</span>
                <button class="btn-circle" onclick="changeCount('tg_premium_3', 1)">+</button>
            </div>
        </div>
        <div class="product-item">
            <div class="product-info"><h3>6 –ú–µ—Å—è—Ü–µ–≤</h3><p>1,500‚ÇΩ</p></div>
            <div class="counter">
                <button class="btn-circle" onclick="changeCount('tg_premium_6', -1)">‚àí</button>
                <span id="count-tg_premium_6" class="count-val">0</span>
                <button class="btn-circle" onclick="changeCount('tg_premium_6', 1)">+</button>
            </div>
        </div>
        <div class="product-item">
            <div class="product-info"><h3>12 –ú–µ—Å—è—Ü–µ–≤</h3><p>2,750‚ÇΩ</p></div>
            <div class="counter">
                <button class="btn-circle" onclick="changeCount('tg_premium_12', -1)">‚àí</button>
                <span id="count-tg_premium_12" class="count-val">0</span>
                <button class="btn-circle" onclick="changeCount('tg_premium_12', 1)">+</button>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 2: –û–ü–õ–ê–¢–ê -->
    <div id="view-payment" class="view">
        <header>
            <h1>–û–ø–ª–∞—Ç–∞</h1>
            <p class="subtitle">–ó–∞–∫–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω</p>
        </header>

        <div class="payment-info">
            <div style="font-size: 14px; color: #8e8e93;">–ö –æ–ø–ª–∞—Ç–µ:</div>
            <div class="total-amount" id="pay-amount">0‚ÇΩ</div>
            <div style="margin-bottom: 30px;">
                ID: <span class="order-id" id="pay-id">...</span>
            </div>

            <button class="btn-main btn-pay" id="btn-pay-link" onclick="openPaymentLink()">
                üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å
            </button>
            
            <button class="btn-main btn-check" onclick="checkPayment()">
                üîÑ –Ø –æ–ø–ª–∞—Ç–∏–ª
            </button>
            
            <button class="btn-main btn-back" onclick="switchView('view-catalog')">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
            </button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù 3: –£–°–ü–ï–• -->
    <div id="view-success" class="view" style="text-align: center; padding-top: 50px;">
        <span class="success-icon">‚úÖ</span>
        <h1 style="margin-bottom: 10px;">–£—Å–ø–µ—à–Ω–æ!</h1>
        <p style="color: #8e8e93; margin-bottom: 30px;">–í–∞—à –∑–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω.<br>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.</p>
        <button class="btn-main btn-check" onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let cart = { tg_premium_3: 0, tg_premium_6: 0, tg_premium_12: 0 };
        const PRICES = { tg_premium_3: 1250, tg_premium_6: 1500, tg_premium_12: 2750 };
        const STARS_PRICE = 1.6;
        
        let currentOrderId = null;
        let currentPaymentUrl = null;

        // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // –£–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π –¢–µ–ª–µ–≥—Ä–∞–º–∞
            if (viewId === 'view-catalog') {
                updateUI();
            } else {
                tg.MainButton.hide();
            }
        }

        function changeCount(id, delta) {
            tg.HapticFeedback.selectionChanged();
            cart[id] += delta;
            if (cart[id] < 0) cart[id] = 0;
            document.getElementById(`count-${id}`).innerText = cart[id];
            updateUI();
        }

        function updateUI() {
            let total = 0;
            for (let key in cart) total += cart[key] * PRICES[key];

            let starsInput = document.getElementById('starsAmount').value;
            let starsVal = parseInt(starsInput) || 0;
            if (starsVal < 0) starsVal = 0;
            
            let starsCost = starsVal * STARS_PRICE;
            document.getElementById('starsTotal').innerText = starsCost.toLocaleString('ru-RU') + "‚ÇΩ";
            total += starsCost;

            if (total > 0) {
                tg.MainButton.setText(`–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ (${total.toLocaleString('ru-RU')}‚ÇΩ)`);
                tg.MainButton.show();
                tg.MainButton.setParams({ color: '#a980f5', text_color: '#ffffff' });
            } else {
                tg.MainButton.hide();
            }
        }

        // --- –õ–û–ì–ò–ö–ê –°–ï–¢–ò (–û–ë–©–ï–ù–ò–ï –° –ë–û–¢–û–ú) ---

        // 1. –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É "–û—Ñ–æ—Ä–º–∏—Ç—å"
        Telegram.WebApp.onEvent('mainButtonClicked', async function() {
            tg.MainButton.showProgress();
            
            let starsVal = parseInt(document.getElementById('starsAmount').value) || 0;
            const payload = {
                cart: cart,
                stars: starsVal,
                user_id: tg.initDataUnsafe?.user?.id || 0
            };

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –±–æ—Ç–∞
                const response = await fetch('/api/create_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.status === 'ok') {
                    // –£—Å–ø–µ—Ö, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –æ–ø–ª–∞—Ç—ã
                    currentOrderId = data.order_id;
                    currentPaymentUrl = data.payment_url;
                    
                    document.getElementById('pay-amount').innerText = data.amount + '‚ÇΩ';
                    document.getElementById('pay-id').innerText = '#' + data.order_id.slice(0, 8);
                    
                    switchView('view-payment');
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            } finally {
                tg.MainButton.hideProgress();
            }
        });

        // 2. –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–∫–∏ –æ–ø–ª–∞—Ç—ã
        function openPaymentLink() {
            if (currentPaymentUrl) {
                tg.openLink(currentPaymentUrl); // –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ–≤–µ—Ä—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            }
        }

        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã
        async function checkPayment() {
            if (!currentOrderId) return;
            
            tg.HapticFeedback.notificationOccurred('warning'); // –í–∏–±—Ä–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è
            
            try {
                const response = await fetch(`/api/check_payment?order_id=${currentOrderId}`);
                const data = await response.json();
                
                if (data.paid) {
                    tg.HapticFeedback.notificationOccurred('success');
                    switchView('view-success');
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showPopup({
                        title: '–û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
                        message: '–ú—ã –ø–æ–∫–∞ –Ω–µ –≤–∏–¥–∏–º –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤. –ï—Å–ª–∏ –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å–Ω–æ–≤–∞.',
                        buttons: [{type: 'ok'}]
                    });
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏');
            }
        }
    </script>
</body>
</html>
